/**
 * Hybrid Question Service - ãƒã‚¤ãƒ–ãƒªãƒEƒ‰è³ªå•ç”Ÿæˆã‚·ã‚¹ãƒEƒ 
 * 
 * ãƒ–ãƒ­ãƒE‚¯A,C: AIå®ŒåEç”ŸæE (åˆE‡ç‰¹åŒE
 * ãƒ–ãƒ­ãƒE‚¯B,D: è»½é‡ãƒ†ãƒ³ãƒ—ãƒ¬ (æ±ç”¨çšE
 * 
 * APIåŠ¹çE 50%å‰Šæ¸›ã€å“è³ª: é«˜ç¶­æŒE */

import { z } from 'zod';
import { advancedQuestService } from './advancedQuestService.fixed';
import { goalClarificationService, GoalClarificationNeeded } from './goalClarificationService';
import { GoalAnalysis, AdaptiveQuestion, QuestionBlock } from './adaptiveQuestionService';

// ãƒã‚¤ãƒ–ãƒªãƒEƒ‰è³ªå•ç”Ÿæˆçµæœ
export interface HybridQuestionSet {
  goalAnalysis: GoalAnalysis;
  blocks: QuestionBlock[];
  generationMetadata: {
    aiGeneratedBlocks: ('A' | 'B' | 'C' | 'D')[];
    templateBlocks: ('A' | 'B' | 'C' | 'D')[];
    totalApiCalls: number;
    generationTime: number;
  };
}

class HybridQuestionService {
  /**
   * ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒE ãƒã‚¤ãƒ–ãƒªãƒEƒ‰è³ªå•ã‚»ãƒEƒˆç”ŸæE
   */
  async generateHybridQuestionSet(goalText: string): Promise<HybridQuestionSet> {
    const startTime = Date.now();
    let apiCalls = 0;

    // Step 1: æ›–æ˜§æ€§ãƒã‚§ãƒE‚¯
    await goalClarificationService.validateGoalOrThrow(goalText);
    apiCalls++;

    // Step 2: ç›®æ¨™è§£æE    const goalAnalysis = await this.analyzeGoal(goalText);
    apiCalls++;

    // Step 3: åEƒ–ãƒ­ãƒE‚¯ç”ŸæE (ãƒã‚¤ãƒ–ãƒªãƒEƒ‰æˆ¦ç•¥)
    const blocks: QuestionBlock[] = [];

    // ãƒ–ãƒ­ãƒE‚¯A: AIç”ŸæE (ç›®æ¨™ç„¦ç‚¹ - åˆE‡ç‰¹åŒ–å¿E E
    blocks.push(await this.generateBlockA_AI(goalAnalysis));
    apiCalls++;

    // ãƒ–ãƒ­ãƒE‚¯B: ãƒEƒ³ãƒ—ãƒ¬ (å­¦ç¿’æ–¹é‡E- æ±ç”¨çšE
    blocks.push(this.generateBlockB_Template(goalAnalysis));

    // ãƒ–ãƒ­ãƒE‚¯C: AIç”ŸæE (æˆæœç¢ºèªE- è©•ä¾¡æ–¹æ³•ãEåˆE‡ä¾å­E
    blocks.push(await this.generateBlockC_AI(goalAnalysis));
    apiCalls++;

    // ãƒ–ãƒ­ãƒE‚¯D: ãƒEƒ³ãƒ—ãƒ¬ (ç¶™ç¶šå¯¾ç­E- æŒ«æŠ˜ãEæ±ç”¨çšE
    blocks.push(this.generateBlockD_Template(goalAnalysis));

    const generationTime = Date.now() - startTime;

    return {
      goalAnalysis,
      blocks,
      generationMetadata: {
        aiGeneratedBlocks: ['A', 'C'],
        templateBlocks: ['B', 'D'],
        totalApiCalls: apiCalls,
        generationTime
      }
    };
  }

  /**
   * ç›®æ¨™è§£æE(Phase 1ã‹ã‚‰æ”¹è‰¯)
   */
  private async analyzeGoal(goalText: string): Promise<GoalAnalysis> {
    if (!advancedQuestService.isInitialized()) {
      throw new Error('AdvancedQuestService not initialized');
    }

    const analysisPrompt = `ä»¥ä¸‹ãEå­¦ç¿’ç›®æ¨™ã‚’åˆEã—ã¦ã€JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€E
ç›®æ¨E "${goalText}"

ä»¥ä¸‹ãEå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
  "domain": "language|programming|business|creative|academic|fitness|general",
  "subDomain": "å…·ä½“çš„ãªã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³",
  "learningType": "knowledge|skill|habit|outcome",
  "complexity": "beginner|intermediate|advanced", 
  "timeHorizon": "short|medium|long",
  "keyTerms": ["é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒE", "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒE"]
}

åˆEè¦³ç‚¹:
- domain: ä¸»è¦ãªå­¦ç¿’åEé‡E(creative=ãƒE‚¶ã‚¤ãƒ³ãƒ»éŸ³æ¥½ãƒ»èŠ¸è¡E academic=å­¦å•ãEè³E ¼, fitness=é‹å‹•ãƒ»å¥åº·ã‚’å«ã‚€)
- subDomain: ã‚ˆã‚Šå…·ä½“çš„ãªå°‚é–€é ˜åŸŸ
- learningType: knowledge(çŸ¥è­˜ç¿’å¾E/skill(ã‚¹ã‚­ãƒ«å‘ä¸E/habit(ç¿’æEå½¢æˆE/outcome(çµæœé”æE)
- complexity: beginner/intermediate/advanced
- timeHorizon: short(1-3æœE/medium(3-6æœE/long(6æœE)
- keyTerms: ç›®æ¨™ã«å«ã¾ã‚Œã‚‹é‡è¦ãªç”¨èª`;

    try {
      const response = await advancedQuestService.generateCustom({
        userGoal: goalText,
        timeConstraintMinutes: 30,
        userPreferences: { difficulty: 'medium' },
        customPrompt: analysisPrompt
      });

      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰JSONã‚’æŠ½å‡º
      const jsonMatch = response.match(/\{[\s\S]*?\}/);
      if (!jsonMatch) {
        throw new Error('No JSON found in AI response');
      }

      const analysisData = JSON.parse(jsonMatch[0]);
      
      // ãƒEEã‚¿æ¤œè¨¼
      const validatedAnalysis: GoalAnalysis = {
        domain: this.validateDomain(analysisData.domain),
        subDomain: analysisData.subDomain || 'general_learning',
        learningType: this.validateLearningType(analysisData.learningType),
        complexity: this.validateComplexity(analysisData.complexity),
        timeHorizon: this.validateTimeHorizon(analysisData.timeHorizon),
        keyTerms: Array.isArray(analysisData.keyTerms) ? analysisData.keyTerms.slice(0, 5) : []
      };

      console.log('ğŸ” Hybrid Goal Analysis:', validatedAnalysis);
      return validatedAnalysis;

    } catch (error) {
      console.error('AI goal analysis failed, using fallback:', error);
      return this.basicGoalAnalysis(goalText);
    }
  }

  /**
   * ãƒ–ãƒ­ãƒE‚¯A: AIç”ŸæEç‰E(ç›®æ¨™ç„¦ç‚¹)
   */
  private async generateBlockA_AI(goalAnalysis: GoalAnalysis): Promise<QuestionBlock> {
    const prompt = `å­¦ç¿’ç›®æ¨™ãEç„¦ç‚¹ã‚’æEç¢ºã«ã™ã‚‹è³ªå•ã‚’3ã¤ç”ŸæEã—ã¦ãã ã•ã„ã€E
ç›®æ¨™åEé‡E ${goalAnalysis.domain} (${goalAnalysis.subDomain})
å­¦ç¿’ã‚¿ã‚¤ãƒE ${goalAnalysis.learningType}
è¤E›‘ãE ${goalAnalysis.complexity}

ä»¥ä¸‹ãEJSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
  "blockTitle": "ç›®æ¨™ãEç„¦ç‚¹",
  "blockDescription": "ç›®æ¨™è¨­å®šã‚’å…·ä½“åŒ–ã—ã¾ãE,
  "questions": [
    {
      "id": "A1",
      "question": "ã“ãEåˆE‡ã§æœ€ã‚‚é‡è¦–ã—ãŸã„ã®ã¯ã©ã®å´é¢ã§ã™ã‹EE,
      "options": [
        {"id": "opt1", "label": "é¸æŠè‚¢1", "value": "value1", "dataKey": "goal_focus"},
        {"id": "opt2", "label": "é¸æŠè‚¢2", "value": "value2", "dataKey": "goal_focus"},
        {"id": "opt3", "label": "é¸æŠè‚¢3", "value": "value3", "dataKey": "goal_focus"},
        {"id": "opt4", "label": "é¸æŠè‚¢4", "value": "value4", "dataKey": "goal_focus"}
      ]
    },
    {
      "id": "A2", 
      "question": "ã‚ˆã‚Šå…·ä½“çš„ã«ã¯ã©ã®ã‚ˆã†ãªèƒ½åŠ›ã§ã™ã‹EE,
      "options": [
        {"id": "opt1", "label": "é¸æŠè‚¢1", "value": "value1", "dataKey": "domain_scenes"},
        {"id": "opt2", "label": "é¸æŠè‚¢2", "value": "value2", "dataKey": "domain_scenes"},
        {"id": "opt3", "label": "é¸æŠè‚¢3", "value": "value3", "dataKey": "domain_scenes"},
        {"id": "opt4", "label": "é¸æŠè‚¢4", "value": "value4", "dataKey": "domain_scenes"}
      ]
    },
    {
      "id": "A3",
      "question": "ã©ã®ã‚ˆã†ãªå­¦ç¿’ç¯E›²ã§å–ã‚ŠçµE¿ã¾ã™ã‹EE, 
      "options": [
        {"id": "broad", "label": "å¹EºEå­¦ã‚“ã§å…¨ä½“åƒã‚’æŠŠæ¡", "value": "broad", "dataKey": "scope_style"},
        {"id": "prioritized", "label": "é‡è¦ãªãƒEEãƒã«çµã£ã¦å­¦ç¿E, "value": "prioritized", "dataKey": "scope_style"},
        {"id": "deep", "label": "ã²ã¨ã¤ã®ã“ã¨ã‚’æ·±ãè¿½æ±E, "value": "deep", "dataKey": "scope_style"},
        {"id": "undecided", "label": "é€²ã‚ãªãŒã‚‰æ±ºã‚ãŸãE, "value": "undecided", "dataKey": "scope_style"}
      ]
    }
  ]
}

å¿E ˆè¦ä»¶:
- åE³ªå•ãE4æŠã§ã€E{goalAnalysis.domain}åˆE‡ã«ç‰¹åŒ–ã—ãŸåEå®¹
- é¸æŠè‚¢ã¯å…·ä½“çš„ã§åˆE‹ã‚Šã‚„ã™ã
- dataKeyã¯æŒE®šã•ã‚ŒãŸã‚‚ãEã‚’ä½¿ç”¨`;

    try {
      const response = await advancedQuestService.generateCustom({
        userGoal: `${goalAnalysis.domain} - ${goalAnalysis.subDomain}`,
        timeConstraintMinutes: 30,
        userPreferences: { difficulty: 'medium' },
        customPrompt: prompt
      });

      const jsonMatch = response.match(/\{[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error('No JSON found in BlockA AI response');
      }

      const blockData = JSON.parse(jsonMatch[0]);
      
      return {
        blockId: 'A',
        blockTitle: blockData.blockTitle || 'ç›®æ¨™ãEç„¦ç‚¹',
        blockDescription: blockData.blockDescription || `${goalAnalysis.domain}ã®ç›®æ¨™è¨­å®šã‚’å…·ä½“åŒ–ã—ã¾ã™`,
        questions: blockData.questions.map((q: any, index: number) => ({
          id: `A${index + 1}`,
          blockId: 'A' as const,
          stepInBlock: (index + 1) as 1 | 2 | 3,
          question: q.question,
          options: q.options,
          hasOptionalMemo: true,
          goalContext: `${goalAnalysis.domain}åˆE‡ã§ã®è³ªå•E{index + 1}`
        }))
      };

    } catch (error) {
      console.error('BlockA AI generation failed, using fallback:', error);
      return this.generateBlockA_Fallback(goalAnalysis);
    }
  }

  /**
   * ãƒ–ãƒ­ãƒE‚¯B: ãƒEƒ³ãƒ—ãƒ¬ç‰E(å­¦ç¿’æ–¹é‡E - æ±ç”¨çšE   */
  private generateBlockB_Template(goalAnalysis: GoalAnalysis): QuestionBlock {
    return {
      blockId: 'B',
      blockTitle: 'å­¦ç¿’ãEé€²ã‚æ–¹',
      blockDescription: 'æ–°ã—ã„ã“ã¨ã¨å¾©ç¿’ãEãƒãƒ©ãƒ³ã‚¹ã€E »åº¦ã€E›£æ˜“åº¦ã‚’è¨­å®šã—ã¾ãE,
      questions: [
        {
          id: 'B1',
          blockId: 'B',
          stepInBlock: 1,
          question: 'æ–°ã—ã„ã“ã¨ã‚’å­¦ã¶ã®ã¨å¾©ç¿’ã€ã©ã¡ã‚‰ãŒå¤šã‚ãŒã„ãE§ã™ã‹EE,
          options: [
            { id: 'new_heavy', label: 'æ–°ã—ã„ã“ã¨ã‚’ãŸãã•ã‚“å­¦ã³ãŸã„', value: 0.75, dataKey: 'novelty_preference' },
            { id: 'new_some', label: 'æ–°ã—ã„ã“ã¨ã‚’å°‘ã—å¤šã‚ã«', value: 0.60, dataKey: 'novelty_preference' },
            { id: 'repeat_some', label: 'å¾©ç¿’ã‚’å°‘ã—å¤šã‚ã«', value: 0.40, dataKey: 'novelty_preference' },
            { id: 'repeat_heavy', label: 'å¾©ç¿’ã‚’ã—ã£ã‹ã‚Šã‚E‚ŠãŸã„', value: 0.25, dataKey: 'novelty_preference' }
          ],
          hasOptionalMemo: true,
          goalContext: 'å­¦ç¿’ã«ãŠã‘ã‚‹æ–°è¦vså¾©ç¿’ãEãƒãƒ©ãƒ³ã‚¹è¨­å®E
        },
        {
          id: 'B2',
          blockId: 'B',
          stepInBlock: 2,
          question: 'å¾©ç¿’ãEã©ã®ãã‚‰ãEEé »åº¦ãŒã„ãE§ã™ã‹EE,
          options: [
            { id: 'daily', label: 'æ¯æ—¥ã‚³ãƒE‚³ãƒE¨', value: 'daily', dataKey: 'review_cadence' },
            { id: 'every_other_day', label: 'E’æ—¥ã«E‘å›ç¨‹åº¦', value: 'every_other_day', dataKey: 'review_cadence' },
            { id: 'weekly', label: 'E‘é€±é–“ã«E‘å›ç¨‹åº¦', value: 'weekly', dataKey: 'review_cadence' },
            { id: 'milestone', label: 'åŒºåˆE‚Šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§', value: 'milestone', dataKey: 'review_cadence' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'B1',
          goalContext: 'å¾©ç¿’é »åº¦ã®è¨­å®E
        },
        {
          id: 'B3',
          blockId: 'B',
          stepInBlock: 3,
          question: 'ã©ã®ãã‚‰ãEƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸãE§ã™ã‹EE,
          options: [
            { id: 'easy', label: 'ç„¡çEEãªãE¯E›²ã§', value: -0.1, dataKey: 'difficulty_bias' },
            { id: 'normal', label: 'é©åº¦ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§', value: 0, dataKey: 'difficulty_bias' },
            { id: 'challenge_some', label: 'å°‘ã—èƒŒä¼¸ã³ã—ãŸãE, value: 0.1, dataKey: 'difficulty_bias' },
            { id: 'challenge_much', label: 'ã©ã‚“ã©ã‚“ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸãE, value: 0.2, dataKey: 'difficulty_bias' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'B2',
          goalContext: 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¬ãƒ™ãƒ«ã®è¨­å®E
        }
      ]
    };
  }

  /**
   * ãƒ–ãƒ­ãƒE‚¯C: AIç”ŸæEç‰E(æˆæœç¢ºèªE
   */
  private async generateBlockC_AI(goalAnalysis: GoalAnalysis): Promise<QuestionBlock> {
    const prompt = `æˆæœã®ç¢ºèªæ–¹æ³•ã‚’è¨­å®šã™ã‚‹è³ªå•ã‚’3ã¤ç”ŸæEã—ã¦ãã ã•ã„ã€E
ç›®æ¨™åEé‡E ${goalAnalysis.domain} (${goalAnalysis.subDomain})
å­¦ç¿’ã‚¿ã‚¤ãƒE ${goalAnalysis.learningType}

ä»¥ä¸‹ãEJSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
  "blockTitle": "æˆæœã®ç¢ºèªæ–¹æ³E,
  "blockDescription": "å­¦ç¿’æEæœã‚’ã©ãE¢ºèªã™ã‚‹ã‹ã‚’è¨­å®šã—ã¾ãE, 
  "questions": [
    {
      "id": "C1",
      "question": "ã€Œã§ããŸEã€ã‚’ã©ãE‚„ã£ã¦ç¢ºèªã—ãŸã„ã§ã™ã‹EE,
      "options": [
        {"id": "opt1", "label": "é¸æŠè‚¢1", "value": "value1", "dataKey": "goal_evidence"},
        {"id": "opt2", "label": "é¸æŠè‚¢2", "value": "value2", "dataKey": "goal_evidence"},
        {"id": "opt3", "label": "é¸æŠè‚¢3", "value": "value3", "dataKey": "goal_evidence"},
        {"id": "opt4", "label": "é¸æŠè‚¢4", "value": "value4", "dataKey": "goal_evidence"}
      ]
    },
    {
      "id": "C2",
      "question": "ã©ã‚“ãªç›®æ¨™è¨­å®šã«ã—ã¾ã™ã‹EE,
      "options": [
        {"id": "opt1", "label": "é¸æŠè‚¢1", "value": "value1", "dataKey": "kpi_shape"},
        {"id": "opt2", "label": "é¸æŠè‚¢2", "value": "value2", "dataKey": "kpi_shape"},
        {"id": "opt3", "label": "é¸æŠè‚¢3", "value": "value3", "dataKey": "kpi_shape"},
        {"id": "opt4", "label": "é¸æŠè‚¢4", "value": "value4", "dataKey": "kpi_shape"}
      ]
    },
    {
      "id": "C3",
      "question": "æœ€çµ‚çš„ã«ã©ã‚“ãªå½¢ã§ä»•ä¸Šã’ãŸã„ã§ã™ã‹EE,
      "options": [
        {"id": "opt1", "label": "é¸æŠè‚¢1", "value": "value1", "dataKey": "capstone_type"},
        {"id": "opt2", "label": "é¸æŠè‚¢2", "value": "value2", "dataKey": "capstone_type"},
        {"id": "opt3", "label": "é¸æŠè‚¢3", "value": "value3", "dataKey": "capstone_type"},
        {"id": "opt4", "label": "é¸æŠè‚¢4", "value": "value4", "dataKey": "capstone_type"}
      ]
    }
  ]
}

å¿E ˆè¦ä»¶:
- ${goalAnalysis.domain}åˆE‡ã«ç‰¹åŒ–ã—ãŸè©•ä¾¡æ–¹æ³E- é¸æŠè‚¢ã¯å®Ÿç¾å¯èƒ½ã§å…·ä½“çš„ãªã‚‚ãE
- dataKeyã¯æŒE®šã•ã‚ŒãŸã‚‚ãEã‚’ä½¿ç”¨`;

    try {
      const response = await advancedQuestService.generateCustom({
        userGoal: `${goalAnalysis.domain} - ${goalAnalysis.subDomain}`,
        timeConstraintMinutes: 30,
        userPreferences: { difficulty: 'medium' },
        customPrompt: prompt
      });

      const jsonMatch = response.match(/\{[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error('No JSON found in BlockC AI response');
      }

      const blockData = JSON.parse(jsonMatch[0]);
      
      return {
        blockId: 'C',
        blockTitle: blockData.blockTitle || 'æˆæœã®ç¢ºèªæ–¹æ³E,
        blockDescription: blockData.blockDescription || `${goalAnalysis.domain}ã®æˆæœç¢ºèªæ–¹æ³•ã‚’è¨­å®šã—ã¾ã™`,
        questions: blockData.questions.map((q: any, index: number) => ({
          id: `C${index + 1}`,
          blockId: 'C' as const,
          stepInBlock: (index + 1) as 1 | 2 | 3,
          question: q.question,
          options: q.options,
          hasOptionalMemo: true,
          goalContext: `${goalAnalysis.domain}åˆE‡ã§ã®æˆæœç¢ºèªE{index + 1}`
        }))
      };

    } catch (error) {
      console.error('BlockC AI generation failed, using fallback:', error);
      return this.generateBlockC_Fallback(goalAnalysis);
    }
  }

  /**
   * ãƒ–ãƒ­ãƒE‚¯D: ãƒEƒ³ãƒ—ãƒ¬ç‰E(ç¶™ç¶šå¯¾ç­E - æ±ç”¨çšE   */
  private generateBlockD_Template(goalAnalysis: GoalAnalysis): QuestionBlock {
    return {
      blockId: 'D',
      blockTitle: 'ç¶™ç¶šãEãŸã‚ã®å¯¾ç­E,
      blockDescription: 'æŒ«æŠ˜ã—ã‚E™ãEƒ‘ã‚¿ãƒ¼ãƒ³ã¨å¯¾å‡¦æ³•ã‚’è¨­å®šã—ã¾ãE,
      questions: [
        {
          id: 'D1',
          blockId: 'D',
          stepInBlock: 1,
          question: 'ã©ã‚“ãªæ™‚ã«ã¤ã¾ãšãã‚E™ãE§ã™ã‹EE,
          options: [
            { id: 'time', label: 'æ™‚é–“ãŒãªãã¦ç¶™ç¶šã§ããªãE, value: 'time', dataKey: 'dropoff_type' },
            { id: 'difficulty', label: 'å†E®¹ãŒé›£ã—ãã¦é€²ã¾ãªãE, value: 'difficulty', dataKey: 'dropoff_type' },
            { id: 'focus', label: 'é›E¸­ãŒç¶šã‹ãšæ°—ãŒæ•£ã£ã¦ã—ã¾ãE, value: 'focus', dataKey: 'dropoff_type' },
            { id: 'meaning', label: 'ãªã‚“ãEãŸã‚ã«ã‚E£ã¦ãE‚‹ã‹åEã‹ã‚‰ãªãE, value: 'meaning', dataKey: 'dropoff_type' }
          ],
          hasOptionalMemo: true,
          goalContext: 'å…¸å‹çš„ãªæŒ«æŠ˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å®E
        },
        {
          id: 'D2',
          blockId: 'D',
          stepInBlock: 2,
          question: 'ã©ã‚“ãªãã£ã‹ã‘ã§ã‚E‚ã¦ã—ã¾ãEŒã¡ã§ã™ã‹EE,
          options: [
            { id: 'fatigue', label: 'ä»•äº‹ã§ç–²ã‚Œã¦ã‚E‚‹æ°—ãŒèµ·ããªãE, value: 'fatigue', dataKey: 'dropoff_trigger' },
            { id: 'schedule_slip', label: 'äºˆå®šãŒã‚ºãƒ¬ã¦æ™‚é–“ãŒãªããªã‚E, value: 'schedule_slip', dataKey: 'dropoff_trigger' },
            { id: 'notification_noise', label: 'ã‚¹ãƒãEã‚E›‘éŸ³ã§é›E¸­ãŒé€”åEã‚Œã‚‹', value: 'notification_noise', dataKey: 'dropoff_trigger' },
            { id: 'task_too_long', label: 'ã‚E‚‹ã“ã¨ãŒå¤šãã¦é¢å€’ã«ãªã‚E, value: 'task_too_long', dataKey: 'dropoff_trigger' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'D1',
          goalContext: 'æŒ«æŠ˜ãEãã£ã‹ã‘ã¨ãªã‚‹åEä½“çš„ãªãƒˆãƒªã‚¬ãƒ¼'
        },
        {
          id: 'D3',
          blockId: 'D',
          stepInBlock: 3,
          question: 'ãE¾ãã„ã‹ãªãE™‚ã¯ã©ãE—ãŸã„ã§ã™ã‹EE,
          options: [
            { id: 'micro_switch', label: 'çŸ­æ™‚é–“ã§ã§ãã‚‹ã“ã¨ã«åˆE‚Šæ›¿ãˆã‚‹', value: 'micro_switch', dataKey: 'fallback_strategy' },
            { id: 'defer', label: 'æ˜æ—¥ã«ç¹°ã‚Šè¶Šã—ã¦ãƒªã‚»ãƒEƒˆã™ã‚‹', value: 'defer', dataKey: 'fallback_strategy' },
            { id: 'substitute', label: 'ã‚‚ã£ã¨ç°¡å˜ãªã“ã¨ã«å¤‰æ›´ã™ã‚‹', value: 'substitute', dataKey: 'fallback_strategy' },
            { id: 'announce', label: 'èª°ã‹ã«å ±å‘Šã—ã¦ã‚µãƒãEãƒˆã‚’æ±‚ã‚ã‚E, value: 'announce', dataKey: 'fallback_strategy' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'D1_D2',
          goalContext: 'æŒ«æŠ˜æ™‚ã®å›å¾©æˆ¦ç•¥'
        }
      ]
    };
  }

  // =====================
  // ãƒ¦ãƒ¼ãƒE‚£ãƒªãƒE‚£é–¢æ•°
  // =====================

  private validateDomain(domain: string): GoalAnalysis['domain'] {
    const validDomains = ['language', 'programming', 'business', 'creative', 'academic', 'fitness', 'general'];
    return validDomains.includes(domain) ? domain as GoalAnalysis['domain'] : 'general';
  }

  private validateLearningType(type: string): GoalAnalysis['learningType'] {
    const validTypes = ['knowledge', 'skill', 'habit', 'outcome'];
    return validTypes.includes(type) ? type as GoalAnalysis['learningType'] : 'skill';
  }

  private validateComplexity(complexity: string): GoalAnalysis['complexity'] {
    const validComplexities = ['beginner', 'intermediate', 'advanced'];
    return validComplexities.includes(complexity) ? complexity as GoalAnalysis['complexity'] : 'intermediate';
  }

  private validateTimeHorizon(horizon: string): GoalAnalysis['timeHorizon'] {
    const validHorizons = ['short', 'medium', 'long'];
    return validHorizons.includes(horizon) ? horizon as GoalAnalysis['timeHorizon'] : 'medium';
  }

  private basicGoalAnalysis(goalText: string): GoalAnalysis {
    const text = goalText.toLowerCase();
    
    // åŸºæœ¬çšEªãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¤å®E    let domain: GoalAnalysis['domain'] = 'general';
    let subDomain = 'general_learning';
    
    if (text.includes('è‹±èªE) || text.includes('english')) {
      domain = 'language'; subDomain = 'english_learning';
    } else if (text.includes('ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°') || text.includes('react')) {
      domain = 'programming'; subDomain = 'web_development';
    } else if (text.includes('ãƒ“ã‚¸ãƒã‚¹') || text.includes('å–¶æ¥­')) {
      domain = 'business'; subDomain = 'business_skills';
    } else if (text.includes('ãƒE‚¶ã‚¤ãƒ³') || text.includes('éŸ³æ¥½')) {
      domain = 'creative'; subDomain = 'creative_skills';
    } else if (text.includes('è³E ¼') || text.includes('è©¦é¨E)) {
      domain = 'academic'; subDomain = 'certification';
    } else if (text.includes('ç­‹ãƒˆãƒ¬') || text.includes('ãƒ€ã‚¤ã‚¨ãƒEƒˆ')) {
      domain = 'fitness'; subDomain = 'fitness_training';
    }

    return {
      domain,
      subDomain,
      learningType: 'skill',
      complexity: 'intermediate',
      timeHorizon: 'medium',
      keyTerms: goalText.split(/\s|ã€E).filter(term => term.length > 1).slice(0, 3)
    };
  }

  private generateBlockA_Fallback(goalAnalysis: GoalAnalysis): QuestionBlock {
    return {
      blockId: 'A',
      blockTitle: 'ç›®æ¨™ãEç„¦ç‚¹',
      blockDescription: `${goalAnalysis.domain}ã®ç›®æ¨™è¨­å®šã‚’å…·ä½“åŒ–ã—ã¾ã™`,
      questions: [
        {
          id: 'A1',
          blockId: 'A',
          stepInBlock: 1,
          question: 'ã“ãEå­¦ç¿’ã§ã©ã®ã‚ˆã†ãªå´é¢ã‚’é‡è¦–ã—ãŸã„ã§ã™ã‹EE,
          options: [
            { id: 'knowledge', label: 'ã¾ãšãEçŸ¥ã‚‹ãEã‚ã‹ã‚‹ã‚’å¢—ã‚„ã—ãŸãE, value: 'knowledge', dataKey: 'goal_focus' },
            { id: 'skill', label: 'ã§ãã‚‹ã“ã¨ã‚’å¢—ã‚„ã—ãŸãE, value: 'skill', dataKey: 'goal_focus' },
            { id: 'outcome', label: 'çµæœEˆåˆæ ¼/æ•°å­Eé E½ï¼‰ã‚’å‡ºã—ãŸãE, value: 'outcome', dataKey: 'goal_focus' },
            { id: 'habit', label: 'ç¶šã‘ã‚‹ç¿’æEã‚’ã¤ãã‚ŠãŸã„', value: 'habit', dataKey: 'goal_focus' }
          ],
          hasOptionalMemo: true,
          goalContext: 'åŸºæœ¬çšEªå­¦ç¿’ç›®çšEEç¢ºèªE
        },
        {
          id: 'A2',
          blockId: 'A',
          stepInBlock: 2,
          question: 'ã‚ˆã‚Šå…·ä½“çš„ã«ã¯ã©ã®ã‚ˆã†ãªèƒ½åŠ›ã§ã™ã‹EE,
          options: [
            { id: 'general', label: 'å…¨èˆ¬çšEªèƒ½åŠ›å‘ä¸E, value: 'general', dataKey: 'domain_scenes' },
            { id: 'practical', label: 'å®Ÿè·µçšEªã‚¹ã‚­ãƒ«', value: 'practical', dataKey: 'domain_scenes' },
            { id: 'foundational', label: 'åŸºç¤å›ºã‚E, value: 'foundational', dataKey: 'domain_scenes' },
            { id: 'specialized', label: 'å°‚é–€æ€§ã‚’é«˜ã‚ã‚E, value: 'specialized', dataKey: 'domain_scenes' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'A1',
          goalContext: 'èƒ½åŠ›ãEå…·ä½“åŒ–'
        },
        {
          id: 'A3',
          blockId: 'A',
          stepInBlock: 3,
          question: 'ã©ã®ã‚ˆã†ãªå­¦ç¿’ç¯E›²ã§å–ã‚ŠçµE¿ã¾ã™ã‹EE,
          options: [
            { id: 'broad', label: 'å¹EºEå­¦ã‚“ã§å…¨ä½“åƒã‚’æŠŠæ¡', value: 'broad', dataKey: 'scope_style' },
            { id: 'prioritized', label: 'é‡è¦ãªãƒEEãƒã«çµã£ã¦å­¦ç¿E, value: 'prioritized', dataKey: 'scope_style' },
            { id: 'deep', label: 'ã²ã¨ã¤ã®ã“ã¨ã‚’æ·±ãè¿½æ±E, value: 'deep', dataKey: 'scope_style' },
            { id: 'undecided', label: 'é€²ã‚ãªãŒã‚‰æ±ºã‚ãŸãE, value: 'undecided', dataKey: 'scope_style' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'A2',
          goalContext: 'å­¦ç¿’ç¯E›²ã®è¨­å®E
        }
      ]
    };
  }

  private generateBlockC_Fallback(goalAnalysis: GoalAnalysis): QuestionBlock {
    return {
      blockId: 'C',
      blockTitle: 'æˆæœã®ç¢ºèªæ–¹æ³E,
      blockDescription: `${goalAnalysis.domain}ã®æˆæœç¢ºèªæ–¹æ³•ã‚’è¨­å®šã—ã¾ã™`,
      questions: [
        {
          id: 'C1',
          blockId: 'C',
          stepInBlock: 1,
          question: 'ã€Œã§ããŸEã€ã‚’ã©ãE‚„ã£ã¦ç¢ºèªã—ãŸã„ã§ã™ã‹EE,
          options: [
            { id: 'credential_score', label: 'ãƒE‚¹ãƒˆã‚„è©¦é¨“ãEç‚¹æ•°ã§', value: 'credential_score', dataKey: 'goal_evidence' },
            { id: 'portfolio_demo', label: 'ä½œå“ã‚EEãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã§', value: 'portfolio_demo', dataKey: 'goal_evidence' },
            { id: 'realworld_result', label: 'å®Ÿéš›ã®ä»•äº‹ã‚„å®Ÿç¸¾ã§', value: 'realworld_result', dataKey: 'goal_evidence' },
            { id: 'presentation_review', label: 'ç™ºè¡¨ã‚Eƒ¬ãƒ“ãƒ¥ãƒ¼ã§', value: 'presentation_review', dataKey: 'goal_evidence' }
          ],
          hasOptionalMemo: true,
          goalContext: 'æˆæœã®ç¢ºèªæ–¹æ³E
        },
        {
          id: 'C2',
          blockId: 'C',
          stepInBlock: 2,
          question: 'ã©ã‚“ãªç›®æ¨™è¨­å®šã«ã—ã¾ã™ã‹EE,
          options: [
            { id: 'kpi_1', label: 'ã¾ãšãE1ã¤ã®ç›®æ¨™é”æˆE, value: 'kpi_1', dataKey: 'kpi_shape' },
            { id: 'kpi_2', label: '2ã¤ã®ç›®æ¨™ã‚’ä¸¦è¡E, value: 'kpi_2', dataKey: 'kpi_shape' },
            { id: 'kpi_quality', label: 'è³ªé‡è¦–ã§1ã¤ã‚’å¾¹åºE, value: 'kpi_quality', dataKey: 'kpi_shape' },
            { id: 'kpi_flexible', label: 'çŠ¶æ³ã«å¿œã˜ã¦èª¿æ•´', value: 'kpi_flexible', dataKey: 'kpi_shape' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'C1',
          goalContext: 'ç›®æ¨™è¨­å®šãEæ–¹é‡E
        },
        {
          id: 'C3',
          blockId: 'C',
          stepInBlock: 3,
          question: 'æœ€çµ‚çš„ã«ã©ã‚“ãªå½¢ã§ä»•ä¸Šã’ãŸã„ã§ã™ã‹EE,
          options: [
            { id: 'test', label: 'æ¨¡è©¦ã‚Eœ¬ç•ªè©¦é¨“ã§', value: 'test', dataKey: 'capstone_type' },
            { id: 'demo', label: 'ãƒEƒ¢ã‚E½œå“å…¬é–‹ã§', value: 'demo', dataKey: 'capstone_type' },
            { id: 'production', label: 'å®Ÿéš›ã®é‹ç”¨ã‚E´å“ã§', value: 'production', dataKey: 'capstone_type' },
            { id: 'presentation', label: 'ç™ºè¡¨ã‚Eƒ¬ãƒ“ãƒ¥ãƒ¼ä¼šã§', value: 'presentation', dataKey: 'capstone_type' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'C2',
          goalContext: 'æœ€çµ‚æEæœç‰©ã®å½¢å¼E
        }
      ]
    };
  }
}

export const hybridQuestionService = new HybridQuestionService();
export type { HybridQuestionSet };

