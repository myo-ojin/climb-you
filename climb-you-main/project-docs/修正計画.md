# MVP向け 修正計画（AI実行プロンプト）

目的: Expo React Native アプリをMVPリリース可能な状態にする。最短でビルドを通し、主要導線（起動→タスク追加/切替/削除・オンボーディング/デモ判定）が動くことをゴールにする。

---

## 重大エラー一覧（現状の阻害要因）
- 依存関係不整合
  - `expo@~53` と `react-native@0.79.5` のズレ。`typescript: ~5.8.3` は存在せず解決不能。
  - `@react-native-firebase/*` 依存はあるが、コードは `firebase` SDK v9 を使用。二重依存の温床。
- 文字化け/未閉じクォートによる構文エラー多数
  - 日本語文や絵文字の破損、`</Text>` 崩れ、クォート未閉じなど。
  - 影響例: `src/config/apiKeys.ts`, `src/services/firebase/profileService.ts`, `src/screens/TasksScreen.tsx`, `src/screens/ProfileScreen.tsx`, `src/navigation/AppNavigator.tsx`, `test_*.js`。
- Firebase初期化の非標準
  - エミュレータ接続を `initializeFirestore` のホスト設定で代替。`connect*Emulator` を未使用。
- UIの壊れ
  - 文言破損や閉じタグ不正でビルド不可・実行時クラッシュの可能性。
- 機能フラグの齟齬
  - `API_CONFIG.USE_MOCK_AI` が固定true。デモ/本番の意図と不整合化のリスク。

---

## 修正プラン（この通りに順次実行）

### 1) 依存関係を Expo SDK 53 に整合
- 修正: `climb-you-main/package.json`
  - `react-native`: Expo SDK 53 に一致（`npx expo install react-native` で自動整合）。
  - `typescript`: 存在する安定版に（`npx expo install typescript` 推奨）。
  - 未使用の `@react-native-firebase/*` を削除（本体は `firebase` v9 利用）。
  - 未使用の `framer-motion` も削除（参照が無ければ）。
- 検証:
  - `npx expo install --fix`
  - `npm ls` でUNMET無し
  - `npx expo-doctor` の警告を最小化

### 2) 文字化け/JSX破損の全修復（最優先）
- ポリシー:
  - 対象: `src/**/*.ts{,x}` と `test_*.js`。UTF-8 (BOMなし) に統一。
  - 文字列は原則ダブルクォートに統一。壊れた日本語/絵文字は自然文かASCIIへ置換。
  - JSX閉じタグを総点検（`/Text>` の誤記や未閉じを修正）。
- 最低限修復が必要なファイル:
  - `src/config/apiKeys.ts`
    - 例: `return '未設定;` → `return "未設定";`
    - 例: `errors.push('...無効でぁE);` → `errors.push("OpenAI API keyの形式が無効です");`
    - `USE_MOCK_AI` は `process.env.EXPO_PUBLIC_USE_MOCK_AI === 'true'` に変更。
  - `src/services/firebase/profileService.ts`
    - 例: `diagnosis.testWriteResult = 'Write successful ✁E;` → `diagnosis.testWriteResult = "Write successful ✅";`
  - `src/screens/TasksScreen.tsx`, `src/screens/ProfileScreen.tsx`, `src/navigation/AppNavigator.tsx`
    - 全ての壊れた文字列・閉じタグ・テンプレートを修復。アラート文・ラベルも自然な日本語に戻す。
- 検証:
  - `npx tsc --noEmit` でTypeScriptエラー0
  - `npm start` で画面遷移時クラッシュ無し

### 3) Firebase 初期化/エミュレータ接続の是正
- 修正: `src/config/firebaseConfig.ts`
  - 正式な手順に統一：
    - `const app = initializeApp(config);`
    - `const firestore = getFirestore(app);`
    - `if (useEmulator) connectFirestoreEmulator(firestore, host, port);`
    - `auth/functions` も同様に `connectAuthEmulator` / `connectFunctionsEmulator`。
  - 既存 `initializeFirestore(app, { host, ssl: false, experimentalForceLongPolling })` ベースは廃止。
- ポリシー:
  - `EnvironmentConfig.isDemoMode()` が true → Firebase完全スキップ or ローカルストレージ経路に統一。
- 検証:
  - デモ/本番の双方で `initializeFirebaseServices()` が例外なく完了。
  - 本番時、匿名サインイン→ Firestore簡易書込みが成功。

### 4) ナビゲーション最小化（MVPのための縮退）
- `AppNavigator.tsx` はまず `Main`/`Tasks`/`Profile` の3タブに限定。壊れているラベル文字列を修復。
- `ProfileScreen.tsx` は最低限の情報（レベル・完了率・環境）表示に一旦縮退。破損文や未閉じタグを優先修復。
- 検証: 起動→3タブ遷移→モーダル表示（Tasksの追加/削除）でクラッシュ無し。

### 5) 型・品質チェックの土台整備
- `tsconfig.json`: 既存 `strict: true` 維持、`skipLibCheck: true` 維持でOK。
- 任意: Prettier設定導入（`npx prettier --check .` がパースエラー0）。
- 検証: `npx tsc --noEmit` エラー0、Expo dev server 起動OK。

### 6) Serena（Python）は後段対応
- Node/Expoと独立。MVP優先は低い。将来に備えCIで `poe lint`/`poe test` が回る状態に。
- 手順:
  - `cd serena && uv venv && uv pip install --all-extras -r pyproject.toml -e .`
  - `poe lint` / `poe test` / `poe type-check`

---

## 受け入れ基準（Definition of Done）
- `npm install` 成功、`npx expo-doctor` の重大警告が解消。
- `npx tsc --noEmit` でエラー0。
- `npm start` → Expo DevTools 起動、Android/iOS/Web のいずれかで表示OK。
- ユーザーフロー:
  - 初回起動→（デモ/本番）分岐→タスク画面で「追加/完了/削除」が動作。
- Firebase:
  - デモ: ローカルストレージフォールバックでクラッシュ無し。
  - 本番: 匿名サインインの上、テスト書込み（小さなドキュメント）成功。
- 機微情報: `.env` は `.gitignore` 済み。キーのハードコード無し。

---

## AI向け精密実行手順（そのまま渡してください）

1. 依存整合
   - `climb-you-main/package.json` を編集：
     - `@react-native-firebase/*` を削除。
     - `framer-motion` 未使用なら削除。
     - `npx expo install --fix` を実行して `react-native`/`react`/`typescript` をExpo SDK 53に整合。
   - 検証: `npm ls`, `npx expo-doctor`。

2. 文字化け/JSX修復（必須ファイルから順に）
   - `src/config/apiKeys.ts`: 全ての壊れ文字列を修復。`USE_MOCK_AI` は `process.env.EXPO_PUBLIC_USE_MOCK_AI === 'true'` に変更。
   - `src/services/firebase/profileService.ts`: 破損ログ/クォート修正、ASCII/自然日本語に戻す。
   - `src/screens/TasksScreen.tsx`, `src/screens/ProfileScreen.tsx`, `src/navigation/AppNavigator.tsx`: 文字列を `"` に統一、閉じタグ総点検。
   - 検証: `npx tsc --noEmit`。

3. Firebase初期化の是正
   - `src/config/firebaseConfig.ts` を修正：
     - `getFirestore(app)` で生成、エミュは `connectFirestoreEmulator(firestore, host, port)` を使用。
     - `connectAuthEmulator`, `connectFunctionsEmulator` も同様に条件分岐接続。
     - `initializeFirestore(...host...)` ベースは撤廃。
   - デモ時はFirebase全スキップ or ローカル実装にフォールバックを徹底。

4. ナビ最小化と画面の縮退
   - `AppNavigator.tsx`: `Main`/`Tasks`/`Profile` の3タブのみ、一旦有効化。
   - `ProfileScreen.tsx`: 統計/環境表示の最低限だけを安定動作に修復。

5. 検証
   - `npx tsc --noEmit` → 0
   - `npm start` → 画面表示とタスク操作が完了すること。
   - デモ/本番それぞれで Firebase 初期化の失敗がアプリクラッシュに波及しないこと。

（任意）6. Serena の静的品質/テスト
- `cd serena && uv venv && uv pip install --all-extras -r pyproject.toml -e .`
- `poe lint` / `poe test` / `poe type-check`

---

## 参考コマンド
```bash
cd climb-you-main
npm install
npx expo install --fix
npx expo-doctor
npx tsc --noEmit
npm start
# Android/iOS/Web: npm run android | npm run ios | npm run web

# Serena
cd serena
uv venv
uv pip install --all-extras -r pyproject.toml -e .
poe lint
poe test
poe type-check
```

---

## 注意・補足
- `.env` に実キーが含まれているため、共有厳禁。CIでは環境変数注入に切替。
- `test_*.js` も文字化けが多いため、後回し可（MVP可動には不要）。整備時はJSON/ASCII中心に再記述。
- `advancedQuestService.fixed.ts` と `advancedQuestService.ts` の重複は将来的に集約（今回のMVP範囲外）。

---

## 対象ファイル（抜粋）
- `package.json`
- `src/config/apiKeys.ts`
- `src/config/firebaseConfig.ts`
- `src/services/firebase/profileService.ts`
- `src/screens/TasksScreen.tsx`
- `src/screens/ProfileScreen.tsx`
- `src/navigation/AppNavigator.tsx`
- （任意）`test_*.js`

以上。
