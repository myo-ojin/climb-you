/**
 * Hybrid Question Service - ãƒã‚¤ãƒ–ãƒªãƒEƒ‰è³ªå•ç”Ÿæˆã‚·ã‚¹ãƒEƒ 
 * 
 * ãƒ–ãƒ­ãƒE‚¯A,C: AIå®ŒåEç”ŸæE (åˆE‡ç‰¹åŒE
 * ãƒ–ãƒ­ãƒE‚¯B,D: è»½é‡ãƒ†ãƒ³ãƒ—ãƒ¬ (æ±ç”¨çšE
 * 
 * APIåŠ¹çE 50%å‰Šæ¸›ã€å“è³ª: é«˜ç¶­æŒE */

import { z } from 'zod';
import { advancedQuestService } from './advancedQuestService.fixed';
import { goalClarificationService, GoalClarificationNeeded } from './goalClarificationService';
import { GoalAnalysis, AdaptiveQuestion, QuestionBlock } from './adaptiveQuestionService';

// ãƒã‚¤ãƒ–ãƒªãƒEƒ‰è³ªå•ç”Ÿæˆçµæœ
export interface HybridQuestionSet {
  goalAnalysis: GoalAnalysis;
  blocks: QuestionBlock[];
  generationMetadata: {
    aiGeneratedBlocks: ('A' | 'B' | 'C' | 'D')[];
    templateBlocks: ('A' | 'B' | 'C' | 'D')[];
    totalApiCalls: number;
    generationTime: number;
  };
}

class HybridQuestionService {
  /**
   * ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒE ãƒã‚¤ãƒ–ãƒªãƒEƒ‰è³ªå•ã‚»ãƒEƒˆç”ŸæE
   */
  async generateHybridQuestionSet(goalText: string): Promise<HybridQuestionSet> {
    const startTime = Date.now();
    let apiCalls = 0;

    // Step 1: æ›–æ˜§æ€§ãƒã‚§ãƒE‚¯
    await goalClarificationService.validateGoalOrThrow(goalText);
    apiCalls++;

    // Step 2: ç›®æ¨™è§£æE    const goalAnalysis = await this.analyzeGoal(goalText);
    apiCalls++;

    // Step 3: åEƒ–ãƒ­ãƒE‚¯ç”ŸæE (ãƒã‚¤ãƒ–ãƒªãƒEƒ‰æˆ¦ç•¥)
    const blocks: QuestionBlock[] = [];

    // ãƒ–ãƒ­ãƒE‚¯A: AIç”ŸæE (ç›®æ¨™ç„¦ç‚¹ - åˆE‡ç‰¹åŒ–å¿E E
    blocks.push(await this.generateBlockA_AI(goalAnalysis));
    apiCalls++;

    // ãƒ–ãƒ­ãƒE‚¯B: ãƒEƒ³ãƒ—ãƒ¬ (å­¦ç¿’æ–¹é‡E- æ±ç”¨çšE
    blocks.push(this.generateBlockB_Template(goalAnalysis));

    // ãƒ–ãƒ­ãƒE‚¯C: AIç”ŸæE (æˆæœç¢ºèªE- è©•ä¾¡æ–¹æ³•ãEåˆE‡ä¾å­E
    blocks.push(await this.generateBlockC_AI(goalAnalysis));
    apiCalls++;

    // ãƒ–ãƒ­ãƒE‚¯D: ãƒEƒ³ãƒ—ãƒ¬ (ç¶™ç¶šå¯¾ç­E- æŒ«æŠ˜ãEæ±ç”¨çšE
    blocks.push(this.generateBlockD_Template(goalAnalysis));

    const generationTime = Date.now() - startTime;

    return {
      goalAnalysis,
      blocks,
      generationMetadata: {
        aiGeneratedBlocks: ['A', 'C'],
        templateBlocks: ['B', 'D'],
        totalApiCalls: apiCalls,
        generationTime
      }
    };
  }

  /**
   * ç›®æ¨™è§£æE(Phase 1ã‹ã‚‰æ”¹è‰¯)
   */
  private async analyzeGoal(goalText: string): Promise<GoalAnalysis> {
    if (!advancedQuestService.isInitialized()) {
      throw new Error('AdvancedQuestService not initialized');
    }

    const analysisPrompt = `ä»¥ä¸‹ãEå­¦ç¿’ç›®æ¨™ã‚’åˆEã—ã¦ã€JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€E
ç›®æ¨E "${goalText}"

ä»¥ä¸‹ãEå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
  "domain": "language|programming|business|creative|academic|fitness|general",
  "subDomain": "å…·ä½“çš„ãªã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³",
  "learningType": "knowledge|skill|habit|outcome",
  "complexity": "beginner|intermediate|advanced", 
  "timeHorizon": "short|medium|long",
  "keyTerms": ["é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒE", "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒE"]
}

åˆEè¦³ç‚¹:
- domain: ä¸»è¦ãªå­¦ç¿’åEé‡E(creative=ãƒE‚¶ã‚¤ãƒ³ãƒ»éŸ³æ¥½ãƒ»èŠ¸è¡E academic=å­¦å•ãEè³E ¼, fitness=é‹å‹•ãƒ»å¥åº·ã‚’å«ã‚€)
- subDomain: ã‚ˆã‚Šå…·ä½“çš„ãªå°‚é–€é ˜åŸŸ
- learningType: knowledge(çŸ¥è­˜ç¿’å¾E/skill(ã‚¹ã‚­ãƒ«å‘ä¸E/habit(ç¿’æEå½¢æˆE/outcome(çµæœé”æE)
- complexity: beginner/intermediate/advanced
- timeHorizon: short(1-3æœE/medium(3-6æœE/long(6æœE)
- keyTerms: ç›®æ¨™ã«å«ã¾ã‚Œã‚‹é‡è¦ãªç”¨èª`;

    // å¼·åŒ–ç‰ˆanalysisãƒ—ãƒ­ãƒ³ãƒ—ãƒˆEESONãƒ•ã‚§ãƒ³ã‚¹ã¨èªå½™ã‚«ã‚¿ãƒ­ã‚°ã‚’å‰ç½®ãï¼E    const analysisPrompt2 = `æ¬¡ã®å­¦ç¿’ç›®æ¨™ã‚’åˆEã—ã€æŒ‡å®šãEèªå½™ã«æ­£è¦åŒ–ã—ãŸJSONã®ã¿ã‚Eã¤ã®```json```ã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹å†E§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚æ—¥æœ¬èªãEä¸å¯§ä½“ã§ã€ä½™åEãªèª¬æ˜ã‚„è¦‹åEã—ãEä¸€åˆEEåŠ›ã—ãªãE“ã¨ã€Eèªå½™ã‚«ã‚¿ãƒ­ã‚°Eˆå¿Ešã“ãEé›Eˆã‹ã‚‰é¸ã¶/æœ€ã‚‚è¿‘ã„ã‚‚ãEã«ä¸¸ã‚ã‚‹EE- domain: ["language","programming","business","creative","academic","fitness","general"]
- learningType: ["knowledge","skill","habit","outcome"]
- complexity: ["beginner","intermediate","advanced"]
- timeHorizon: ["short","medium","long"]

å‡ºåŠ›å½¢å¼ï¼ˆä¾‹ã§ã¯ãªãå³å®ˆï¼E```json
{
  "domain": "language|programming|business|creative|academic|fitness|general",
  "subDomain": "å…·ä½“çš„ãªã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³EˆèEç”±è¨˜è¿°ã€ã‚¹ãƒãEã‚¯ã‚±ãƒ¼ã‚¹æ¨å¥¨EE,
  "learningType": "knowledge|skill|habit|outcome",
  "complexity": "beginner|intermediate|advanced",
  "timeHorizon": "short|medium|long",
  "keyTerms": ["é‡è¦èªE","é‡è¦èªE","é‡è¦èªE"]
}
```

æŒE¤º
- æœªçŸ¥ã®ã‚«ãƒE‚´ãƒªã¯æœ€ã‚‚è¿‘ã„èªå½™ã«ãƒãƒƒãƒ—ã™ã‚‹ã“ã¨ã€E- keyTermsã¯æœ€å¤§5å€‹ã€E‡è¤E™¤å»ã€åŠè§’è‹±æ•°ãƒ»å°æ–‡å­—ã‚¹ãƒãEã‚¯ã‚±ãƒ¼ã‚¹æ¨å¥¨ã€E- JSONã®ã¿ã‚’åEåŠ›ï¼ˆãƒ•ã‚§ãƒ³ã‚¹å¤–ã«ä½•ã‚‚æ›¸ã‹ãªãE¼‰ã€‚`;
    try {
      const response = await advancedQuestService.generateCustom({
        userGoal: goalText,
        timeConstraintMinutes: 30,
        userPreferences: { difficulty: 'medium' },
        customPrompt: analysisPrompt2
      });

      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰JSONã‚’æŠ½å‡º
      const jsonMatch = response.match(/\{[\s\S]*?\}/);
      if (!jsonMatch) {
        throw new Error('No JSON found in AI response');
      }

      const analysisData = JSON.parse(jsonMatch[0]);
      
      // ãƒEEã‚¿æ¤œè¨¼
      const validatedAnalysis: GoalAnalysis = {
        domain: this.validateDomain(analysisData.domain),
        subDomain: analysisData.subDomain || 'general_learning',
        learningType: this.validateLearningType(analysisData.learningType),
        complexity: this.validateComplexity(analysisData.complexity),
        timeHorizon: this.validateTimeHorizon(analysisData.timeHorizon),
        keyTerms: Array.isArray(analysisData.keyTerms) ? analysisData.keyTerms.slice(0, 5) : []
      };

      console.log('ğŸ” Hybrid Goal Analysis:', validatedAnalysis);
      return validatedAnalysis;

    } catch (error) {
      console.error('AI goal analysis failed, using fallback:', error);
      return this.basicGoalAnalysis(goalText);
    }
  }

  /**
   * ãƒ–ãƒ­ãƒE‚¯A: AIç”ŸæEç‰E(ç›®æ¨™ç„¦ç‚¹)
   */
  private async generateBlockA_AI(goalAnalysis: GoalAnalysis): Promise<QuestionBlock> {
    const prompt = `å­¦ç¿’ç›®æ¨™ãEç„¦ç‚¹ã‚’æEç¢ºã«ã™ã‚‹è³ªå•ã‚’3ã¤ç”ŸæEã—ã¦ãã ã•ã„ã€E
ç›®æ¨™åEé‡E ${goalAnalysis.domain} (${goalAnalysis.subDomain})
å­¦ç¿’ã‚¿ã‚¤ãƒE ${goalAnalysis.learningType}
è¤E›‘ãE ${goalAnalysis.complexity}

ä»¥ä¸‹ãEJSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
  "blockTitle": "ç›®æ¨™ãEç„¦ç‚¹",
  "blockDescription": "ç›®æ¨™è¨­å®šã‚’å…·ä½“åŒ–ã—ã¾ãE,
  "questions": [
    {
      "id": "A1",
      "question": "ã“ãEåˆE‡ã§æœ€ã‚‚é‡è¦–ã—ãŸã„ã®ã¯ã©ã®å´é¢ã§ã™ã‹EE,
      "options": [
        {"id": "opt1", "label": "é¸æŠè‚¢1", "value": "value1", "dataKey": "goal_focus"},
        {"id": "opt2", "label": "é¸æŠè‚¢2", "value": "value2", "dataKey": "goal_focus"},
        {"id": "opt3", "label": "é¸æŠè‚¢3", "value": "value3", "dataKey": "goal_focus"},
        {"id": "opt4", "label": "é¸æŠè‚¢4", "value": "value4", "dataKey": "goal_focus"}
      ]
    },
    {
      "id": "A2", 
      "question": "ã‚ˆã‚Šå…·ä½“çš„ã«ã¯ã©ã®ã‚ˆã†ãªèƒ½åŠ›ã§ã™ã‹EE,
      "options": [
        {"id": "opt1", "label": "é¸æŠè‚¢1", "value": "value1", "dataKey": "domain_scenes"},
        {"id": "opt2", "label": "é¸æŠè‚¢2", "value": "value2", "dataKey": "domain_scenes"},
        {"id": "opt3", "label": "é¸æŠè‚¢3", "value": "value3", "dataKey": "domain_scenes"},
        {"id": "opt4", "label": "é¸æŠè‚¢4", "value": "value4", "dataKey": "domain_scenes"}
      ]
    },
    {
      "id": "A3",
      "question": "ã©ã®ã‚ˆã†ãªå­¦ç¿’ç¯E›²ã§å–ã‚ŠçµE¿ã¾ã™ã‹EE, 
      "options": [
        {"id": "broad", "label": "å¹EºEå­¦ã‚“ã§å…¨ä½“åƒã‚’æŠŠæ¡", "value": "broad", "dataKey": "scope_style"},
        {"id": "prioritized", "label": "é‡è¦ãªãƒEEãƒã«çµã£ã¦å­¦ç¿E, "value": "prioritized", "dataKey": "scope_style"},
        {"id": "deep", "label": "ã²ã¨ã¤ã®ã“ã¨ã‚’æ·±ãè¿½æ±E, "value": "deep", "dataKey": "scope_style"},
        {"id": "undecided", "label": "é€²ã‚ãªãŒã‚‰æ±ºã‚ãŸãE, "value": "undecided", "dataKey": "scope_style"}
      ]
    }
  ]
}

å¿E ˆè¦ä»¶:
- åE³ªå•ãE4æŠã§ã€E{goalAnalysis.domain}åˆE‡ã«ç‰¹åŒ–ã—ãŸåEå®¹
- é¸æŠè‚¢ã¯å…·ä½“çš„ã§åˆE‹ã‚Šã‚„ã™ã
- dataKeyã¯æŒE®šã•ã‚ŒãŸã‚‚ãEã‚’ä½¿ç”¨`;

    try {
      const finalPromptA = `æ¬¡ã®æ¡ä»¶ã§ã€ç›®æ¨™ã«ç„¦ç‚¹ã‚’åˆã‚ã›ã‚‹è³ªå•ãƒ–ãƒ­ãƒE‚¯EEE‰ã‚’ä½œæEã—ã¦ãã ã•ã„ã€‚åEåŠ›ãEå¿Eš1ã¤ã®```json```ã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹å†EEJSONã®ã¿ã€‚æ—¥æœ¬èªãEä¸å¯§ä½“ã§ã€ä½™åEãªèª¬æ˜ã‚„è¦‹åEã—ãEå‡ºåŠ›ã—ãªãE“ã¨ã€Eã‚³ãƒ³ãƒE‚­ã‚¹ãƒE- é ˜åŸŸ: ${goalAnalysis.domain} (${goalAnalysis.subDomain})
- å­¦ç¿’ã‚¿ã‚¤ãƒE ${goalAnalysis.learningType}
- ä»£è¡¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒE ${(goalAnalysis.keyTerms || []).slice(0,5).join(', ')}

è¦ä»¶
- è³ªå•ãEã¡ã‚E†ã©3å•ã€‚å„å•ãE1è«–ç‚¹ã®ã¿ã§é‡è¤E—ãªãE“ã¨ã€E- åE³ªå•ãE4ã¤ã®é¸æŠè‚¢ã‚’æŒã¤ã€‚ä¸­ç«‹çš„ãƒ»å®Ÿè¡Œå¯èƒ½ãƒ»å…·ä½“çš„ãªãƒ©ãƒ™ãƒ«ã€E- åE³ªå•ãEé¸æŠè‚¢ã«ã¯ä¸Šè¨˜ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³/ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”±æ¥ã®å›ºæœ‰èªã‚’æœ€ä½Eèªå«ã‚ã‚‹ã€E- åE¸æŠè‚¢ã¯ {id,label,value,dataKey} ã‚’æŒã¤ã€‚å„è³ªå•åEã§ dataKey ã¨ value ã®å‹ã‚’ä¸€è²«ã•ã›ã‚‹ã€E- dataKeyã¯ A1="goal_focus", A2="domain_scenes", A3="scope_style" ã‚’å¿Ešä½¿ç”¨ã€E- value ã¯æ–E­—åEEˆå°æ–‡å­—ã‚¹ãƒãEã‚¯ã‚±ãƒ¼ã‚¹æ¨å¥¨E‰ã€‚ä¾E "accuracy_focus", "component_practice"ã€E
ç‰¹è¨˜äº‹é E¼E1å›ºå®šã‚¬ã‚¤ãƒ‰ï¼E- A1ã®è³ªå•æ–‡ã¯ã€Œã“ã®å­¦ç¿’ã§æœ€ã‚‚é‡è¦–ã—ãŸã„è¦³ç‚¹ã¯ã©ã‚Œã§ã™ã‹EŸã€ã¨ã™ã‚‹ã€E- A1ã®valueã¯æ±ç”¨è»¸Ã—é ˜åŸŸèªã§ä½œã‚‹Eˆä¾E accuracy/speed/breadth/depth/fluency/retention/application ÃEãƒ‰ãƒ¡ã‚¤ãƒ³èªï¼‰ã€E- valueã¯ `<è»¸>_<ä¸»è¦èªE` å½¢å¼ãEåŠè§’å°æ–‡å­—ã‚¹ãƒãEã‚¯ãƒ»24æ–E­—ä»¥å†E¼ˆä¾E `fluency_speaking`, `accuracy_refactor`E‰ã€E
å‡ºåŠ›å½¢å¼ï¼ˆå³å®ˆï¼E```json
{
  "blockTitle": "ç›®æ¨™ãEç„¦ç‚¹",
  "blockDescription": "${goalAnalysis.domain}ã®ç›®æ¨™è¨­å®šã‚’å…·ä½“åŒ–ã—ã¾ãE,
  "questions": [
    {"question": "â€¦", "options": [
      {"id":"opt1","label":"â€¦","value":"â€¦","dataKey":"goal_focus"},
      {"id":"opt2","label":"â€¦","value":"â€¦","dataKey":"goal_focus"},
      {"id":"opt3","label":"â€¦","value":"â€¦","dataKey":"goal_focus"},
      {"id":"opt4","label":"â€¦","value":"â€¦","dataKey":"goal_focus"}
    ]},
    {"question": "â€¦", "options": [
      {"id":"opt1","label":"â€¦","value":"â€¦","dataKey":"domain_scenes"},
      {"id":"opt2","label":"â€¦","value":"â€¦","dataKey":"domain_scenes"},
      {"id":"opt3","label":"â€¦","value":"â€¦","dataKey":"domain_scenes"},
      {"id":"opt4","label":"â€¦","value":"â€¦","dataKey":"domain_scenes"}
    ]},
    {"question": "â€¦", "options": [
      {"id":"opt1","label":"â€¦","value":"â€¦","dataKey":"scope_style"},
      {"id":"opt2","label":"â€¦","value":"â€¦","dataKey":"scope_style"},
      {"id":"opt3","label":"â€¦","value":"â€¦","dataKey":"scope_style"},
      {"id":"opt4","label":"â€¦","value":"â€¦","dataKey":"scope_style"}
    ]}
  ]
}
```

è‡ªå·±æ¤œæŸ»EˆåEåŠ›ç›´å‰ï¼E- 3å•Ã—å„4æŠã‹EdataKeyã¨valueå‹ãŒåE•ã§ä¸€è²«ã—ã¦ãE‚‹ã‹ã€E- åE•ã«å›ºæœ‰èªãŒå«ã¾ã‚Œã¦ãE‚‹ã‹ï¼ˆã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³/ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”±æ¥E‰ã€E- JSONã®ã¿ã‹ï¼ˆãƒ•ã‚§ãƒ³ã‚¹å¤–ã«æ–E­—ãŒãªãE¼‰ã€Eè¦ä»¶é•åãŒã‚ã‚ŒãEæœ€å°ä¿®æ­£ã—ã¦ã‹ã‚‰å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚` + "\n" + prompt;

      const response = await advancedQuestService.generateCustom({
        userGoal: `${goalAnalysis.domain} - ${goalAnalysis.subDomain}`,
        timeConstraintMinutes: 30,
        userPreferences: { difficulty: 'medium' },
        customPrompt: finalPromptA + '\nå‚è€E¼ˆæ§‹é€ ä¾E ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãEã¿ã€‚èªå½™ãE<domain>/<subDomain>/<keyTerms>ã‹ã‚‰ç”ŸæEã€‚ä»¥ä¸‹ãEä¾‹ãEèªãEå‡ºåŠ›ã«å«ã‚ãªãE¼‰\n```json\n{\n  "blockTitle": "ç›®æ¨™ãEç„¦ç‚¹",\n  "blockDescription": "<domain>ã®ç›®æ¨™è¨­å®šã‚’å…·ä½“åŒ–ã—ã¾ãE,\n  "questions": [\n    {\n      "question": "ã“ãEå­¦ç¿’ã§æœ€ã‚‚é‡è¦–ã—ãŸã„è¦³ç‚¹ã¯ã©ã‚Œã§ã™ã‹EE,\n      "options": [\n        {"id":"opt1","label":"æ­£ç¢ºã•ï¼Eä¸»è¦èªA>EE,"value":"accuracy_<ä¸»è¦èªA>","dataKey":"goal_focus"},\n        {"id":"opt2","label":"é€Ÿåº¦EEä¸»è¦èªB>EE,"value":"speed_<ä¸»è¦èªB>","dataKey":"goal_focus"},\n        {"id":"opt3","label":"æ·±ã•ï¼Eä¸»è¦èªC>EE,"value":"depth_<ä¸»è¦èªC>","dataKey":"goal_focus"},\n        {"id":"opt4","label":"é©ç”¨EEä¸»è¦èªD>EE,"value":"application_<ä¸»è¦èªD>","dataKey":"goal_focus"}\n      ]\n    }\n  ]\n}\n```\néã‚¢ãƒ³ã‚«ãƒ¼æŒE¤º: ä¸Šè¨˜ãEä¾‹ã«ç™»å ´ã™ã‚‹èªãEå‡ºåŠ›ã¸å«ã‚ãªãE“ã¨ã€‚èªå½™ãEå¿Eš<domain>/<subDomain>/<keyTerms>ã‹ã‚‰ç”ŸæEã™ã‚‹ã“ã¨ã€Enè¿½åŠ ãƒã‚§ãƒE‚¯: å‡ºåŠ›ç›´å‰ã«ã€ä¾‹ãEèªï¼Eeact, cefr, hooks, vocabulary ç­‰ï¼‰ãŒå«ã¾ã‚Œã¦ãEªãE‹ç¢ºèªã—ã€å«ã¾ã‚Œã‚‹å ´åˆãEç½®æ›ã™ã‚E'
      });

      const jsonMatch = response.match(/\{[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error('No JSON found in BlockA AI response');
      }

      const blockData = JSON.parse(jsonMatch[0]);
      
      return {
        blockId: 'A',
        blockTitle: blockData.blockTitle || 'ç›®æ¨™ãEç„¦ç‚¹',
        blockDescription: blockData.blockDescription || `${goalAnalysis.domain}ã®ç›®æ¨™è¨­å®šã‚’å…·ä½“åŒ–ã—ã¾ã™`,
        questions: blockData.questions.map((q: any, index: number) => ({
          id: `A${index + 1}`,
          blockId: 'A' as const,
          stepInBlock: (index + 1) as 1 | 2 | 3,
          question: q.question,
          options: q.options,
          hasOptionalMemo: true,
          goalContext: `${goalAnalysis.domain}åˆE‡ã§ã®è³ªå•E{index + 1}`
        }))
      };

    } catch (error) {
      console.error('BlockA AI generation failed, using fallback:', error);
      return this.generateBlockA_Fallback(goalAnalysis);
    }
  }

  /**
   * ãƒ–ãƒ­ãƒE‚¯B: ãƒEƒ³ãƒ—ãƒ¬ç‰E(å­¦ç¿’æ–¹é‡E - æ±ç”¨çšE   */
  private generateBlockB_Template(goalAnalysis: GoalAnalysis): QuestionBlock {
    return {
      blockId: 'B',
      blockTitle: 'å­¦ç¿’ãEé€²ã‚æ–¹',
      blockDescription: 'æ–°ã—ã„ã“ã¨ã¨å¾©ç¿’ãEãƒãƒ©ãƒ³ã‚¹ã€E »åº¦ã€E›£æ˜“åº¦ã‚’è¨­å®šã—ã¾ãE,
      questions: [
        {
          id: 'B1',
          blockId: 'B',
          stepInBlock: 1,
          question: 'æ–°ã—ã„ã“ã¨ã‚’å­¦ã¶ã®ã¨å¾©ç¿’ã€ã©ã¡ã‚‰ãŒå¤šã‚ãŒã„ãE§ã™ã‹EE,
          options: [
            { id: 'new_heavy', label: 'æ–°ã—ã„ã“ã¨ã‚’ãŸãã•ã‚“å­¦ã³ãŸã„', value: 0.75, dataKey: 'novelty_preference' },
            { id: 'new_some', label: 'æ–°ã—ã„ã“ã¨ã‚’å°‘ã—å¤šã‚ã«', value: 0.60, dataKey: 'novelty_preference' },
            { id: 'repeat_some', label: 'å¾©ç¿’ã‚’å°‘ã—å¤šã‚ã«', value: 0.40, dataKey: 'novelty_preference' },
            { id: 'repeat_heavy', label: 'å¾©ç¿’ã‚’ã—ã£ã‹ã‚Šã‚E‚ŠãŸã„', value: 0.25, dataKey: 'novelty_preference' }
          ],
          hasOptionalMemo: true,
          goalContext: 'å­¦ç¿’ã«ãŠã‘ã‚‹æ–°è¦vså¾©ç¿’ãEãƒãƒ©ãƒ³ã‚¹è¨­å®E
        },
        {
          id: 'B2',
          blockId: 'B',
          stepInBlock: 2,
          question: 'å¾©ç¿’ãEã©ã®ãã‚‰ãEEé »åº¦ãŒã„ãE§ã™ã‹EE,
          options: [
            { id: 'daily', label: 'æ¯æ—¥ã‚³ãƒE‚³ãƒE¨', value: 'daily', dataKey: 'review_cadence' },
            { id: 'every_other_day', label: 'E’æ—¥ã«E‘å›ç¨‹åº¦', value: 'every_other_day', dataKey: 'review_cadence' },
            { id: 'weekly', label: 'E‘é€±é–“ã«E‘å›ç¨‹åº¦', value: 'weekly', dataKey: 'review_cadence' },
            { id: 'milestone', label: 'åŒºåˆE‚Šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§', value: 'milestone', dataKey: 'review_cadence' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'B1',
          goalContext: 'å¾©ç¿’é »åº¦ã®è¨­å®E
        },
        {
          id: 'B3',
          blockId: 'B',
          stepInBlock: 3,
          question: 'ã©ã®ãã‚‰ãEƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸãE§ã™ã‹EE,
          options: [
            { id: 'easy', label: 'ç„¡çEEãªãE¯E›²ã§', value: -0.1, dataKey: 'difficulty_bias' },
            { id: 'normal', label: 'é©åº¦ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§', value: 0, dataKey: 'difficulty_bias' },
            { id: 'challenge_some', label: 'å°‘ã—èƒŒä¼¸ã³ã—ãŸãE, value: 0.1, dataKey: 'difficulty_bias' },
            { id: 'challenge_much', label: 'ã©ã‚“ã©ã‚“ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ãŸãE, value: 0.2, dataKey: 'difficulty_bias' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'B2',
          goalContext: 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¬ãƒ™ãƒ«ã®è¨­å®E
        }
      ]
    };
  }

  /**
   * ãƒ–ãƒ­ãƒE‚¯C: AIç”ŸæEç‰E(æˆæœç¢ºèªE
   */
  private async generateBlockC_AI(goalAnalysis: GoalAnalysis): Promise<QuestionBlock> {
    const prompt = `æˆæœã®ç¢ºèªæ–¹æ³•ã‚’è¨­å®šã™ã‚‹è³ªå•ã‚’3ã¤ç”ŸæEã—ã¦ãã ã•ã„ã€E
ç›®æ¨™åEé‡E ${goalAnalysis.domain} (${goalAnalysis.subDomain})
å­¦ç¿’ã‚¿ã‚¤ãƒE ${goalAnalysis.learningType}

ä»¥ä¸‹ãEJSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
  "blockTitle": "æˆæœã®ç¢ºèªæ–¹æ³E,
  "blockDescription": "å­¦ç¿’æEæœã‚’ã©ãE¢ºèªã™ã‚‹ã‹ã‚’è¨­å®šã—ã¾ãE, 
  "questions": [
    {
      "id": "C1",
      "question": "ã€Œã§ããŸEã€ã‚’ã©ãE‚„ã£ã¦ç¢ºèªã—ãŸã„ã§ã™ã‹EE,
      "options": [
        {"id": "opt1", "label": "é¸æŠè‚¢1", "value": "value1", "dataKey": "goal_evidence"},
        {"id": "opt2", "label": "é¸æŠè‚¢2", "value": "value2", "dataKey": "goal_evidence"},
        {"id": "opt3", "label": "é¸æŠè‚¢3", "value": "value3", "dataKey": "goal_evidence"},
        {"id": "opt4", "label": "é¸æŠè‚¢4", "value": "value4", "dataKey": "goal_evidence"}
      ]
    },
    {
      "id": "C2",
      "question": "ã©ã‚“ãªç›®æ¨™è¨­å®šã«ã—ã¾ã™ã‹EE,
      "options": [
        {"id": "opt1", "label": "é¸æŠè‚¢1", "value": "value1", "dataKey": "kpi_shape"},
        {"id": "opt2", "label": "é¸æŠè‚¢2", "value": "value2", "dataKey": "kpi_shape"},
        {"id": "opt3", "label": "é¸æŠè‚¢3", "value": "value3", "dataKey": "kpi_shape"},
        {"id": "opt4", "label": "é¸æŠè‚¢4", "value": "value4", "dataKey": "kpi_shape"}
      ]
    },
    {
      "id": "C3",
      "question": "æœ€çµ‚çš„ã«ã©ã‚“ãªå½¢ã§ä»•ä¸Šã’ãŸã„ã§ã™ã‹EE,
      "options": [
        {"id": "opt1", "label": "é¸æŠè‚¢1", "value": "value1", "dataKey": "capstone_type"},
        {"id": "opt2", "label": "é¸æŠè‚¢2", "value": "value2", "dataKey": "capstone_type"},
        {"id": "opt3", "label": "é¸æŠè‚¢3", "value": "value3", "dataKey": "capstone_type"},
        {"id": "opt4", "label": "é¸æŠè‚¢4", "value": "value4", "dataKey": "capstone_type"}
      ]
    }
  ]
}

å¿E ˆè¦ä»¶:
- ${goalAnalysis.domain}åˆE‡ã«ç‰¹åŒ–ã—ãŸè©•ä¾¡æ–¹æ³E- é¸æŠè‚¢ã¯å®Ÿç¾å¯èƒ½ã§å…·ä½“çš„ãªã‚‚ãE
- dataKeyã¯æŒE®šã•ã‚ŒãŸã‚‚ãEã‚’ä½¿ç”¨`;

    try {
      const finalPromptC = `æ¬¡ã®æ¡ä»¶ã§ã€æEæœãEç¢ºèªæ–¹æ³•ã‚’è¨­å®šã™ã‚‹è³ªå•ãƒ–ãƒ­ãƒE‚¯EEE‰ã‚’ä½œæEã—ã¦ãã ã•ã„ã€‚åEåŠ›ãEå¿Eš1ã¤ã®```json```ã‚³ãƒ¼ãƒ‰ãƒ•ã‚§ãƒ³ã‚¹å†EEJSONã®ã¿ã€‚æ—¥æœ¬èªãEä¸å¯§ä½“ã§ã€ä½™åEãªèª¬æ˜ã‚„è¦‹åEã—ãEå‡ºåŠ›ã—ãªãE“ã¨ã€Eã‚³ãƒ³ãƒE‚­ã‚¹ãƒE- é ˜åŸŸ: ${goalAnalysis.domain} (${goalAnalysis.subDomain})
- å­¦ç¿’ã‚¿ã‚¤ãƒE ${goalAnalysis.learningType}
- ä»£è¡¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒE ${(goalAnalysis.keyTerms || []).slice(0,5).join(', ')}

è¦ä»¶
- è³ªå•ãEã¡ã‚E†ã©3å•ã€‚å„å•ãE1è«–ç‚¹ã®ã¿ã§é‡è¤E—ãªãE“ã¨ã€E- åE³ªå•ãE4ã¤ã®é¸æŠè‚¢ã‚’æŒã¤ã€‚å®Ÿå‹™ä¸ŠãEæ¤œè¨¼/è©•ä¾¡ã«ä½¿ãˆã‚‹å…·ä½“çš„ãƒ©ãƒ™ãƒ«ã€E- åE³ªå•ãEé¸æŠè‚¢ã«ã¯ä¸Šè¨˜ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³/ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”±æ¥ã®å›ºæœ‰èªã‚’æœ€ä½Eèªå«ã‚ã‚‹ã€E- åE¸æŠè‚¢ã¯ {id,label,value,dataKey} ã‚’æŒã¤ã€‚å„è³ªå•åEã§ dataKey ã¨ value ã®å‹ã‚’ä¸€è²«ã•ã›ã‚‹ã€E- dataKeyã¯ C1="goal_evidence", C2="kpi_shape", C3="capstone_type" ã‚’å¿Ešä½¿ç”¨ã€E- value ã¯æ–E­—åEEˆå°æ–‡å­—ã‚¹ãƒãEã‚¯ã‚±ãƒ¼ã‚¹æ¨å¥¨E‰ã€‚ä¾E "demo_rubric", "score_10_items", "portfolio_article"ã€E
ç‰¹è¨˜äº‹é E¼E1å›ºå®šã‚¬ã‚¤ãƒ‰ï¼E- C1ã®è³ªå•æ–‡ã¯ã€Œâ€œã§ããŸâ€ã‚’ã©ã®æ–¹æ³•ã§ç¢ºèªã—ã¾ã™ã‹EŸã€ã¨ã™ã‚‹ã€E- C1ã®valueã¯è©•ä¾¡æ‰‹æ®µÃ—é ˜åŸŸèªã§ä½œã‚‹Eˆä¾E quiz_score/live_demo/artifact/peer_review/rubric_check/time_on_task/log_metric ÃEãƒ‰ãƒ¡ã‚¤ãƒ³èªï¼‰ã€E- valueã¯ `<æ‰‹æ®µ>_<ä¸»è¦èªE` å½¢å¼ãEåŠè§’å°æ–‡å­—ã‚¹ãƒãEã‚¯ãƒ»24æ–E­—ä»¥å†E¼ˆä¾E `live_demo_component`, `quiz_score_vocab`E‰ã€E
å‡ºåŠ›å½¢å¼ï¼ˆå³å®ˆï¼E```json
{
  "blockTitle": "æˆæœã®ç¢ºèªæ–¹æ³E,
  "blockDescription": "${goalAnalysis.domain}ã®å­¦ç¿’æEæœã‚’ã©ã®ã‚ˆã†ã«ç¢ºèªã™ã‚‹ã‹ã‚’è¨­å®šã—ã¾ãE,
  "questions": [
    {"question": "â€¦", "options": [
      {"id":"opt1","label":"â€¦","value":"â€¦","dataKey":"goal_evidence"},
      {"id":"opt2","label":"â€¦","value":"â€¦","dataKey":"goal_evidence"},
      {"id":"opt3","label":"â€¦","value":"â€¦","dataKey":"goal_evidence"},
      {"id":"opt4","label":"â€¦","value":"â€¦","dataKey":"goal_evidence"}
    ]},
    {"question": "â€¦", "options": [
      {"id":"opt1","label":"â€¦","value":"â€¦","dataKey":"kpi_shape"},
      {"id":"opt2","label":"â€¦","value":"â€¦","dataKey":"kpi_shape"},
      {"id":"opt3","label":"â€¦","value":"â€¦","dataKey":"kpi_shape"},
      {"id":"opt4","label":"â€¦","value":"â€¦","dataKey":"kpi_shape"}
    ]},
    {"question": "â€¦", "options": [
      {"id":"opt1","label":"â€¦","value":"â€¦","dataKey":"capstone_type"},
      {"id":"opt2","label":"â€¦","value":"â€¦","dataKey":"capstone_type"},
      {"id":"opt3","label":"â€¦","value":"â€¦","dataKey":"capstone_type"},
      {"id":"opt4","label":"â€¦","value":"â€¦","dataKey":"capstone_type"}
    ]}
  ]
}
```

è‡ªå·±æ¤œæŸ»EˆåEåŠ›ç›´å‰ï¼E- 3å•Ã—å„4æŠã‹EdataKeyã¨valueå‹ãŒåE•ã§ä¸€è²«ã—ã¦ãE‚‹ã‹ã€E- åE•ã«å›ºæœ‰èªãŒå«ã¾ã‚Œã¦ãE‚‹ã‹ï¼ˆã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³/ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”±æ¥E‰ã€E- JSONã®ã¿ã‹ï¼ˆãƒ•ã‚§ãƒ³ã‚¹å¤–ã«æ–E­—ãŒãªãE¼‰ã€Eè¦ä»¶é•åãŒã‚ã‚ŒãEæœ€å°ä¿®æ­£ã—ã¦ã‹ã‚‰å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚` + "\n" + prompt;

      const response = await advancedQuestService.generateCustom({
        userGoal: `${goalAnalysis.domain} - ${goalAnalysis.subDomain}`,
        timeConstraintMinutes: 30,
        userPreferences: { difficulty: 'medium' },
        customPrompt: finalPromptC + '\nå‚è€E¼ˆæ§‹é€ ä¾E ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãEã¿ã€‚èªå½™ãE<domain>/<subDomain>/<keyTerms>ã‹ã‚‰ç”ŸæEã€‚ä»¥ä¸‹ãEä¾‹ãEèªãEå‡ºåŠ›ã«å«ã‚ãªãE¼‰\n```json\n{\n  "blockTitle": "æˆæœã®ç¢ºèªæ–¹æ³E,\n  "blockDescription": "<domain>ã®å­¦ç¿’æEæœã‚’ã©ã®ã‚ˆã†ã«ç¢ºèªã™ã‚‹ã‹ã‚’è¨­å®šã—ã¾ãE,\n  "questions": [\n    {\n      "question": "â€œã§ããŸâ€ã‚’ã©ã®æ–¹æ³•ã§ç¢ºèªã—ã¾ã™ã‹EE,\n      "options": [\n        {"id":"opt1","label":"å°ãƒ†ã‚¹ãƒˆï¼Eä¸»è¦èªEEE,"value":"quiz_score_<ä¸»è¦èªE","dataKey":"goal_evidence"},\n        {"id":"opt2","label":"ãƒEƒ¢EEä¸»è¦èªEEE,"value":"live_demo_<ä¸»è¦èªE","dataKey":"goal_evidence"},\n        {"id":"opt3","label":"æˆæœç‰©æåEEEä¸»è¦èªEEE,"value":"artifact_<ä¸»è¦èªE","dataKey":"goal_evidence"},\n        {"id":"opt4","label":"è©•ä¾¡è¡¨ãƒã‚§ãƒE‚¯EEæŒE¨EEE,"value":"rubric_check_<æŒE¨E","dataKey":"goal_evidence"}\n      ]\n    }\n  ]\n}\n```\néã‚¢ãƒ³ã‚«ãƒ¼æŒE¤º: ä¸Šè¨˜ãEä¾‹ã«ç™»å ´ã™ã‚‹èªãEå‡ºåŠ›ã¸å«ã‚ãªãE“ã¨ã€‚èªå½™ãEå¿Eš<domain>/<subDomain>/<keyTerms>ã‹ã‚‰ç”ŸæEã™ã‚‹ã“ã¨ã€Enè¿½åŠ ãƒã‚§ãƒE‚¯: å‡ºåŠ›ç›´å‰ã«ã€ä¾‹ãEèªï¼Eeact, cefr, hooks, vocabulary ç­‰ï¼‰ãŒå«ã¾ã‚Œã¦ãEªãE‹ç¢ºèªã—ã€å«ã¾ã‚Œã‚‹å ´åˆãEç½®æ›ã™ã‚E'
      });

      const jsonMatch = response.match(/\{[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error('No JSON found in BlockC AI response');
      }

      const blockData = JSON.parse(jsonMatch[0]);
      
      return {
        blockId: 'C',
        blockTitle: blockData.blockTitle || 'æˆæœã®ç¢ºèªæ–¹æ³E,
        blockDescription: blockData.blockDescription || `${goalAnalysis.domain}ã®æˆæœç¢ºèªæ–¹æ³•ã‚’è¨­å®šã—ã¾ã™`,
        questions: blockData.questions.map((q: any, index: number) => ({
          id: `C${index + 1}`,
          blockId: 'C' as const,
          stepInBlock: (index + 1) as 1 | 2 | 3,
          question: q.question,
          options: q.options,
          hasOptionalMemo: true,
          goalContext: `${goalAnalysis.domain}åˆE‡ã§ã®æˆæœç¢ºèªE{index + 1}`
        }))
      };

    } catch (error) {
      console.error('BlockC AI generation failed, using fallback:', error);
      return this.generateBlockC_Fallback(goalAnalysis);
    }
  }

  /**
   * ãƒ–ãƒ­ãƒE‚¯D: ãƒEƒ³ãƒ—ãƒ¬ç‰E(ç¶™ç¶šå¯¾ç­E - æ±ç”¨çšE   */
  private generateBlockD_Template(goalAnalysis: GoalAnalysis): QuestionBlock {
    return {
      blockId: 'D',
      blockTitle: 'ç¶™ç¶šãEãŸã‚ã®å¯¾ç­E,
      blockDescription: 'æŒ«æŠ˜ã—ã‚E™ãEƒ‘ã‚¿ãƒ¼ãƒ³ã¨å¯¾å‡¦æ³•ã‚’è¨­å®šã—ã¾ãE,
      questions: [
        {
          id: 'D1',
          blockId: 'D',
          stepInBlock: 1,
          question: 'ã©ã‚“ãªæ™‚ã«ã¤ã¾ãšãã‚E™ãE§ã™ã‹EE,
          options: [
            { id: 'time', label: 'æ™‚é–“ãŒãªãã¦ç¶™ç¶šã§ããªãE, value: 'time', dataKey: 'dropoff_type' },
            { id: 'difficulty', label: 'å†E®¹ãŒé›£ã—ãã¦é€²ã¾ãªãE, value: 'difficulty', dataKey: 'dropoff_type' },
            { id: 'focus', label: 'é›E¸­ãŒç¶šã‹ãšæ°—ãŒæ•£ã£ã¦ã—ã¾ãE, value: 'focus', dataKey: 'dropoff_type' },
            { id: 'meaning', label: 'ãªã‚“ãEãŸã‚ã«ã‚E£ã¦ãE‚‹ã‹åEã‹ã‚‰ãªãE, value: 'meaning', dataKey: 'dropoff_type' }
          ],
          hasOptionalMemo: true,
          goalContext: 'å…¸å‹çš„ãªæŒ«æŠ˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å®E
        },
        {
          id: 'D2',
          blockId: 'D',
          stepInBlock: 2,
          question: 'ã©ã‚“ãªãã£ã‹ã‘ã§ã‚E‚ã¦ã—ã¾ãEŒã¡ã§ã™ã‹EE,
          options: [
            { id: 'fatigue', label: 'ä»•äº‹ã§ç–²ã‚Œã¦ã‚E‚‹æ°—ãŒèµ·ããªãE, value: 'fatigue', dataKey: 'dropoff_trigger' },
            { id: 'schedule_slip', label: 'äºˆå®šãŒã‚ºãƒ¬ã¦æ™‚é–“ãŒãªããªã‚E, value: 'schedule_slip', dataKey: 'dropoff_trigger' },
            { id: 'notification_noise', label: 'ã‚¹ãƒãEã‚E›‘éŸ³ã§é›E¸­ãŒé€”åEã‚Œã‚‹', value: 'notification_noise', dataKey: 'dropoff_trigger' },
            { id: 'task_too_long', label: 'ã‚E‚‹ã“ã¨ãŒå¤šãã¦é¢å€’ã«ãªã‚E, value: 'task_too_long', dataKey: 'dropoff_trigger' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'D1',
          goalContext: 'æŒ«æŠ˜ãEãã£ã‹ã‘ã¨ãªã‚‹åEä½“çš„ãªãƒˆãƒªã‚¬ãƒ¼'
        },
        {
          id: 'D3',
          blockId: 'D',
          stepInBlock: 3,
          question: 'ãE¾ãã„ã‹ãªãE™‚ã¯ã©ãE—ãŸã„ã§ã™ã‹EE,
          options: [
            { id: 'micro_switch', label: 'çŸ­æ™‚é–“ã§ã§ãã‚‹ã“ã¨ã«åˆE‚Šæ›¿ãˆã‚‹', value: 'micro_switch', dataKey: 'fallback_strategy' },
            { id: 'defer', label: 'æ˜æ—¥ã«ç¹°ã‚Šè¶Šã—ã¦ãƒªã‚»ãƒEƒˆã™ã‚‹', value: 'defer', dataKey: 'fallback_strategy' },
            { id: 'substitute', label: 'ã‚‚ã£ã¨ç°¡å˜ãªã“ã¨ã«å¤‰æ›´ã™ã‚‹', value: 'substitute', dataKey: 'fallback_strategy' },
            { id: 'announce', label: 'èª°ã‹ã«å ±å‘Šã—ã¦ã‚µãƒãEãƒˆã‚’æ±‚ã‚ã‚E, value: 'announce', dataKey: 'fallback_strategy' }
          ],
          hasOptionalMemo: true,
          parentDependency: 'D1_D2',
          goalContext: 'æŒ«æŠ˜æ™‚ã®å›å¾©æˆ¦ç•¥'
        }
      ]
    };
  }

  // =====================
  // ãƒ¦ãƒ¼ãƒE‚£ãƒªãƒE‚£é–¢æ•°
  // =====================

  private validateDomain(domain: string): GoalAnalysis['domain'] {
    const validDomains = ['language', 'programming', 'business', 'creative', 'academic', 'fitness', 'general'];
    return validDomains.includes(domain) ? domain as GoalAnalysis['domain'] : 'general';
  }

